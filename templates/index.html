<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 导演工坊 - 全局配置版</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- 引入 Lucide 图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<!-- 顶部导航栏 -->
<div class="navbar">
    <div class="brand">
        <i data-lucide="wand-2"></i>
        <span>AI 导演工坊</span>
    </div>
    <div class="tools">
        <button id="settings-btn" class="icon-btn">
            <i data-lucide="settings"></i>
        </button>
    </div>
</div>

<div class="container">
    <!-- 左侧控制面板 -->
    <div class="control-panel">
        <h2>PARAMETERS</h2>
        
        <form id="generate-form">
            <div class="form-group">
                <label>MODEL SOURCE / 模型源</label>
                <select name="model_source" id="model_source">
                    <option value="preset">使用预设模型 (Fal/Gemini)</option>
                    <option value="custom">使用自定义 API (第三方)</option>
                </select>
            </div>

            <!-- 预设模型选择 -->
            <div class="form-group" id="preset-group">
                <label>PRESET MODEL / 选择模型</label>
                <select name="model_name">
                    {% for name, id in models.items() %}
                    <option value="{{ name }}">{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- 自定义配置提示 -->
            <div class="form-group" id="custom-group" style="display: none;">
                <div class="info-box">
                    <i data-lucide="info" size="14"></i>
                    <span>将使用右上角设置中的 API 配置</span>
                </div>
            </div>

            <div class="form-group">
                <label>SOURCE IMAGE / 源图片</label>
                <input type="file" name="image" id="file-input" accept="image/*" required>
            </div>

            <!-- 摇杆交互区 -->
            <div class="form-group">
                <label>CAMERA ANGLE / 视角控制</label>
                <div class="joystick-container">
                    <div class="joystick-pad" id="joystick-pad">
                        <div class="crosshair-h"></div>
                        <div class="crosshair-v"></div>
                        <div class="joystick-handle" id="joystick-handle"></div>
                    </div>
                    
                    <div class="coords-display">
                        <div class="coord-box">HOR: <span id="val-h">0</span>°</div>
                        <div class="coord-box">VER: <span id="val-v">0</span>°</div>
                        <div class="coord-box">ZOOM: <span id="val-z">5.0</span></div>
                    </div>

                    <div class="zoom-control">
                        <label style="font-size: 0.8rem;">ZOOM LEVEL</label>
                        <input type="range" id="zoom-slider" min="0" max="100" value="50">
                    </div>

                    <!-- 隐藏参数 -->
                    <input type="hidden" name="h_angle" id="input-h" value="0">
                    <input type="hidden" name="v_angle" id="input-v" value="0">
                    <input type="hidden" name="zoom" id="input-z" value="50">
                </div>
            </div>

            <div class="form-group">
                <label>PROMPT / 提示词</label>
                <input type="text" name="prompt" placeholder="Describe the subject...">
            </div>

            <button type="submit" class="submit-btn" id="submit-btn">GENERATE</button>
        </form>
    </div>

    <!-- 右侧结果面板 -->
    <div class="result-panel">
        <h2>PREVIEW</h2>
        <div id="loading" class="loading-spinner"></div>
        
        <div id="content-area" style="text-align: center; width: 100%;">
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <div>
                    <p style="color:#666">Original</p>
                    <img id="original-preview" class="preview-img" style="display: none;">
                </div>
                <div>
                    <p style="color:var(--accent-color)">Result</p>
                    <img id="result-img" class="result-img" style="display: none;">
                </div>
            </div>
            <p id="status-text" style="margin-top: 20px; color: #888;">Ready to generate.</p>
        </div>
    </div>
</div>

<!-- 全局配置弹窗 (Config Modal) -->
<div id="config-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i data-lucide="server"></i> 第三方 API 配置</h3>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <p class="hint-text">在此填写的配置将保存在本地浏览器中，后端不会永久存储。</p>
            
            <div class="form-group">
                <label>API Base URL (接口地址)</label>
                <input type="text" id="cfg-api-url" placeholder="e.g. https://api.openai.com/v1" value="https://api.openai.com/v1">
            </div>

            <div class="form-group">
                <label>API Key (密钥)</label>
                <input type="password" id="cfg-api-key" placeholder="sk-...">
            </div>

            <div class="form-group">
                <label>Custom Model Name (自定义模型名)</label>
                <input type="text" id="cfg-model-name" placeholder="e.g. gpt-4-vision-preview">
            </div>
        </div>
        <div class="modal-footer">
            <button id="save-config-btn" class="submit-btn">保存配置</button>
        </div>
    </div>
</div>

<script>
    // 初始化图标
    lucide.createIcons();

    // --- 1. 配置弹窗逻辑 ---
    const modal = document.getElementById('config-modal');
    const settingsBtn = document.getElementById('settings-btn');
    const closeSpan = document.getElementsByClassName('close-modal')[0];
    const saveConfigBtn = document.getElementById('save-config-btn');

    // 输入框元素
    const cfgUrl = document.getElementById('cfg-api-url');
    const cfgKey = document.getElementById('cfg-api-key');
    const cfgModel = document.getElementById('cfg-model-name');

    // 打开弹窗
    settingsBtn.onclick = function() {
        // 从 localStorage 加载配置
        const config = JSON.parse(localStorage.getItem('ai_custom_config') || '{}');
        if(config.url) cfgUrl.value = config.url;
        if(config.key) cfgKey.value = config.key;
        if(config.model) cfgModel.value = config.model;
        
        modal.style.display = "flex";
    }

    // 关闭弹窗
    closeSpan.onclick = function() { modal.style.display = "none"; }
    window.onclick = function(event) {
        if (event.target == modal) modal.style.display = "none";
    }

    // 保存配置
    saveConfigBtn.onclick = function() {
        const config = {
            url: cfgUrl.value,
            key: cfgKey.value,
            model: cfgModel.value
        };
        localStorage.setItem('ai_custom_config', JSON.stringify(config));
        modal.style.display = "none";
        alert('配置已保存到本地！');
    }

    // --- 2. 模型源切换逻辑 ---
    const modelSource = document.getElementById('model_source');
    const presetGroup = document.getElementById('preset-group');
    const customGroup = document.getElementById('custom-group');

    modelSource.addEventListener('change', function() {
        if (this.value === 'custom') {
            presetGroup.style.display = 'none';
            customGroup.style.display = 'block';
        } else {
            presetGroup.style.display = 'block';
            customGroup.style.display = 'none';
        }
    });

    // --- 3. 摇杆交互逻辑 (保持不变) ---
    const pad = document.getElementById('joystick-pad');
    const handle = document.getElementById('joystick-handle');
    const valH = document.getElementById('val-h');
    const valV = document.getElementById('val-v');
    const inputH = document.getElementById('input-h');
    const inputV = document.getElementById('input-v');
    let isDragging = false;
    const radius = 100;

    function updateJoystick(x, y) {
        const distance = Math.sqrt(x*x + y*y);
        const maxDist = radius - 10;
        if (distance > maxDist) {
            const angle = Math.atan2(y, x);
            x = Math.cos(angle) * maxDist;
            y = Math.sin(angle) * maxDist;
        }
        handle.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
        const hAngle = Math.round((x / maxDist) * 180);
        const vAngle = Math.round((y / maxDist) * -90);
        valH.innerText = hAngle; valV.innerText = vAngle;
        inputH.value = hAngle; inputV.value = vAngle;
    }

    pad.addEventListener('mousedown', (e) => { isDragging = true; handleMouseMove(e); });
    document.addEventListener('mousemove', (e) => { if (isDragging) handleMouseMove(e); });
    document.addEventListener('mouseup', () => { isDragging = false; });

    function handleMouseMove(e) {
        const rect = pad.getBoundingClientRect();
        const x = e.clientX - (rect.left + rect.width / 2);
        const y = e.clientY - (rect.top + rect.height / 2);
        updateJoystick(x, y);
    }

    const zoomSlider = document.getElementById('zoom-slider');
    const valZ = document.getElementById('val-z');
    const inputZ = document.getElementById('input-z');
    zoomSlider.addEventListener('input', (e) => {
        valZ.innerText = (e.target.value / 10).toFixed(1);
        inputZ.value = e.target.value;
    });

    // --- 4. 表单提交逻辑 (核心修改) ---
    const fileInput = document.getElementById('file-input');
    const originalPreview = document.getElementById('original-preview');
    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => { originalPreview.src = e.target.result; originalPreview.style.display = 'block'; }
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('generate-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submit-btn');
        const loading = document.getElementById('loading');
        const statusText = document.getElementById('status-text');
        const resultImg = document.getElementById('result-img');

        // 验证自定义配置
        const source = modelSource.value;
        const config = JSON.parse(localStorage.getItem('ai_custom_config') || '{}');
        
        if (source === 'custom') {
            if (!config.url || !config.key) {
                alert('请先点击右上角设置图标，填写 API URL 和 Key！');
                return;
            }
        }

        submitBtn.disabled = true;
        loading.style.display = 'block';
        statusText.innerText = "Processing...";
        resultImg.style.display = 'none';

        const formData = new FormData(this);
        
        // 如果是自定义模式，把 LocalStorage 里的配置附加上去
        if (source === 'custom') {
            formData.append('custom_api_url', config.url);
            formData.append('custom_api_key', config.key);
            formData.append('custom_model_name', config.model);
        }

        try {
            const response = await fetch('/generate', { method: 'POST', body: formData });
            const data = await response.json();

            if (data.success) {
                statusText.innerText = "Generation Complete!";
                if (data.data.image_url) {
                    resultImg.src = data.data.image_url;
                    resultImg.style.display = 'block';
                } else {
                    statusText.innerText = data.data.message;
                }
            } else {
                statusText.innerText = "Error: " + data.error;
            }
        } catch (err) {
            statusText.innerText = "Network Error";
            console.error(err);
        } finally {
            submitBtn.disabled = false;
            loading.style.display = 'none';
        }
    });
</script>

</body>
</html>
