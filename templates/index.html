<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å¯¼æ¼”å·¥åŠ | ç²¾å‡†ç©ºé—´ç‰ˆ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=8.0">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body oncontextmenu="return false;">

<header class="studio-header">
    <div class="brand">
        <div class="logo-box"><i data-lucide="orbit"></i></div>
        <div class="brand-text">
            <h1>AI å¯¼æ¼”å·¥åŠ</h1>
            <span class="subtitle">èµ„äº§å›ºå®šçš„å…¨è§’åº¦ç”Ÿæˆç³»ç»Ÿ</span>
        </div>
    </div>
    <div class="header-controls">
        <button id="config-btn" class="tool-btn"><i data-lucide="settings"></i> <span>å…¨å±€è®¾ç½®</span></button>
    </div>
</header>

<div class="main-layout">
    <aside class="control-panel">
        <div class="panel-section">
            <div class="section-header"><i data-lucide="anchor"></i> <span>å›ºå®šèµ„äº§ (Source Asset)</span></div>
            <div class="upload-widget" id="upload-zone">
                <input type="file" id="file-input" accept="image/*" hidden>
                <div id="upload-placeholder" class="placeholder-content">
                    <i data-lucide="scan-face"></i>
                    <p>ä¸Šä¼ è§’è‰²/ç‰©ä½“ (ä½œä¸ºå”¯ä¸€åŸºå‡†)</p>
                </div>
                <img id="source-preview" class="hidden">
            </div>
            <div class="asset-lock-hint">
                <i data-lucide="lock"></i> <span>èµ„äº§å·²é”å®šï¼šæ‰€æœ‰ç”Ÿæˆå‡åŸºäºæ­¤åŸå›¾</span>
            </div>
        </div>

        <div class="panel-section full-height">
            <div class="section-header">
                <div class="header-left"><i data-lucide="axis-3d"></i> <span>ç©ºé—´è§’åº¦å®šä¹‰</span></div>
                <button class="reset-btn" onclick="resetCamera()">å½’é›¶</button>
            </div>
            
            <div class="viewport-3d" id="viewport-3d">
                <div class="instruction-overlay">
                    <div class="inst-item"><i data-lucide="mouse-pointer-2"></i> å·¦é”®ï¼šæ–¹ä½ (Azimuth)</div>
                    <div class="inst-item"><i data-lucide="move-vertical"></i> å·¦é”®ï¼šä»°ä¿¯ (Elevation)</div>
                    <div class="inst-item"><i data-lucide="move"></i> å³é”®ï¼šå¹³ç§»æ„å›¾</div>
                </div>

                <div class="cam-pan-layer" id="cam-pan">
                    <div class="cam-orbit-layer" id="cam-orbit">
                        <div class="cam-zoom-layer" id="cam-zoom">
                            <div class="world-center">
                                <!-- æåæ ‡ç½‘æ ¼ -->
                                <div class="grid-floor">
                                    <div class="axis x-axis"></div>
                                    <div class="axis z-axis"></div>
                                    <div class="degree-mark" style="top: 5%; left: 50%">0Â°</div>
                                    <div class="degree-mark" style="top: 50%; left: 95%">90Â°</div>
                                    <div class="degree-mark" style="top: 95%; left: 50%">180Â°</div>
                                    <div class="degree-mark" style="top: 50%; left: 5%">270Â°</div>
                                    <div class="floor-label">FRONT</div>
                                </div>
                                
                                <div class="subject-card">
                                    <div class="face face-front">
                                        <img id="subject-img-3d" src="">
                                        <div class="no-subject">?</div>
                                    </div>
                                    <div class="face face-back">
                                        <div class="back-pattern">
                                            <i data-lucide="arrow-left-right"></i>
                                            <span>BACK ANGLE</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hud-panel">
                    <div class="hud-row"><span>AZIMUTH</span><span id="val-azi" class="accent">0Â°</span></div>
                    <div class="hud-row"><span>ELEVATION</span><span id="val-ele" class="accent">0Â°</span></div>
                </div>
            </div>
        </div>
    </aside>

    <main class="result-stage">
        <div class="prompt-monitor">
            <div class="monitor-label">PRECISION PROMPT ENGINE (ç²¾å‡†æŒ‡ä»¤)</div>
            <div class="monitor-screen" id="final-prompt">Waiting for input...</div>
            
            <div class="prompt-controls">
                <input type="text" id="extra-prompt" class="extra-input" placeholder="ä¸»ä½“æè¿° (å¦‚: a cyberpunk girl, white hair)...">
                <div class="consistency-badge">
                    <i data-lucide="shield-check"></i> Identity Locked
                </div>
            </div>
        </div>

        <div class="canvas-wrapper">
            <div class="render-actions">
                <select id="model-select" class="model-select-dark">
                    <option value="preset">ğŸš€ é¢„è®¾æ¨¡å‹ (Fal/Qwen)</option>
                    <option value="custom">ğŸ›  è‡ªå®šä¹‰ API</option>
                </select>
                <button id="generate-btn" class="render-btn-large">
                    <i data-lucide="aperture"></i> ç«‹å³æ¸²æŸ“
                </button>
            </div>

            <div class="image-container">
                <div id="empty-state" class="empty-state">
                    <i data-lucide="cube"></i><p>è°ƒæ•´ 3D è§’åº¦ä»¥ç”Ÿæˆè§†å›¾</p>
                </div>
                <div id="loader" class="loader" style="display: none;">
                    <div class="radar-spinner"></div><p>æ­£åœ¨è®¡ç®—ç©ºé—´å‡ ä½•...</p>
                </div>
                <img id="result-img" class="final-image" style="display: none;">
            </div>
        </div>

        <div class="filmstrip"><div class="filmstrip-track" id="filmstrip-track"></div></div>
    </main>
</div>

<!-- API å¼¹çª— (ä¿æŒä¸å˜) -->
<div id="config-modal" class="modal-backdrop">
    <div class="modal-panel">
        <div class="modal-header"><h3>API é…ç½®</h3><button class="close-modal"><i data-lucide="x"></i></button></div>
        <div class="modal-body">
            <div class="input-group"><label>URL</label> <input type="text" id="cfg-url"></div>
            <div class="input-group"><label>Key</label> <input type="password" id="cfg-key"></div>
            <div class="input-group"><label>Model</label> <input type="text" id="cfg-model"></div>
        </div>
        <div class="modal-footer"><button id="save-cfg-btn" class="save-btn">ä¿å­˜</button></div>
    </div>
</div>

<script>
    lucide.createIcons();

    const fileInput = document.getElementById('file-input');
    const sourcePreview = document.getElementById('source-preview');
    const subjectImg3D = document.getElementById('subject-img-3d');
    const placeholder = document.getElementById('upload-placeholder');
    const noSubject = document.querySelector('.no-subject');

    document.getElementById('upload-zone').onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                sourcePreview.src = e.target.result;
                sourcePreview.classList.remove('hidden');
                placeholder.style.display = 'none';
                subjectImg3D.src = e.target.result;
                subjectImg3D.style.display = 'block';
                noSubject.style.display = 'none';
                generatePrecisionPrompt(); // é‡æ–°ç”Ÿæˆ Prompt
            }
            reader.readAsDataURL(file);
        }
    };

    // --- 3D æ ¸å¿ƒäº¤äº’ ---
    const camState = { azi: 0, ele: 0, panX: 0, panY: 0, zoom: 1.0 };
    const layerPan = document.getElementById('cam-pan');
    const layerOrbit = document.getElementById('cam-orbit');
    const layerZoom = document.getElementById('cam-zoom');
    
    const uiAzi = document.getElementById('val-azi');
    const uiEle = document.getElementById('val-ele');
    const finalPrompt = document.getElementById('final-prompt');
    const extraPrompt = document.getElementById('extra-prompt');

    let isDragging = false;
    let dragMode = null;
    let lastX = 0, lastY = 0;

    const viewport = document.getElementById('viewport-3d');
    viewport.addEventListener('mousedown', (e) => {
        isDragging = true; lastX = e.clientX; lastY = e.clientY;
        dragMode = (e.button === 2) ? 'pan' : 'orbit';
        viewport.style.cursor = dragMode === 'orbit' ? 'grabbing' : 'move';
    });

    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const deltaX = e.clientX - lastX;
        const deltaY = e.clientY - lastY;
        lastX = e.clientX; lastY = e.clientY;

        if (dragMode === 'orbit') {
            camState.azi += deltaX * 0.5;
            // ä¿®æ­£ï¼šé¼ æ ‡å‘ä¸‹ -> å¢åŠ è§’åº¦ -> å‘åå€’ -> çœ‹åˆ°é¡¶è§†å›¾
            camState.ele += deltaY * 0.5; 
            camState.ele = Math.max(-85, Math.min(85, camState.ele));
        } else if (dragMode === 'pan') {
            camState.panX += deltaX;
            camState.panY += deltaY; 
        }
        updateCameraVisuals();
    });

    window.addEventListener('mouseup', () => { isDragging = false; viewport.style.cursor = 'grab'; });
    viewport.addEventListener('wheel', (e) => {
        e.preventDefault();
        camState.zoom -= e.deltaY * 0.001; 
        camState.zoom = Math.max(0.2, Math.min(3.0, camState.zoom));
        updateCameraVisuals();
    }, { passive: false });

    function updateCameraVisuals() {
        layerPan.style.transform = `translateX(${camState.panX}px) translateY(${camState.panY}px)`;
        layerOrbit.style.transform = `rotateX(${camState.ele}deg) rotateY(${camState.azi}deg)`;
        layerZoom.style.transform = `scale(${camState.zoom})`;
        
        // è§„èŒƒåŒ–è§’åº¦ 0-360
        let displayAzi = Math.round(camState.azi % 360);
        if (displayAzi < 0) displayAzi += 360;
        
        uiAzi.innerText = `${displayAzi}Â°`;
        uiEle.innerText = `${Math.round(camState.ele)}Â°`;

        generatePrecisionPrompt();
    }

    // --- 4. ä¸“ä¸šçº§æç¤ºè¯å¼•æ“ (The Logic) ---
    // å‚è€ƒ Qwen/HF ç­‰ 3D LoRA çš„å¸¸ç”¨è®­ç»ƒæ ‡ç­¾
    function generatePrecisionPrompt() {
        // è·å–è§„èŒƒåŒ–æ•°æ®
        let azi = Math.round(camState.azi % 360);
        if (azi < 0) azi += 360; // 0 ~ 359
        
        let ele = Math.round(camState.ele); // -85 ~ 85

        // A. æ–¹ä½è§’ (Azimuth) - ç²¾ç»†åŒ–åˆ†æ¡¶
        let aziDesc = "front view";
        
        // ä½¿ç”¨ 8 æ–¹å‘ç½—ç›˜ + ä¸­é—´æ€
        if (azi >= 337.5 || azi < 22.5) aziDesc = "front view (0Â°)";
        else if (azi >= 22.5 && azi < 67.5) aziDesc = "front-right side view (45Â°)";
        else if (azi >= 67.5 && azi < 112.5) aziDesc = "right profile view (90Â°)";
        else if (azi >= 112.5 && azi < 157.5) aziDesc = "back-right view (135Â°)";
        else if (azi >= 157.5 && azi < 202.5) aziDesc = "back view (180Â°)";
        else if (azi >= 202.5 && azi < 247.5) aziDesc = "back-left view (225Â°)";
        else if (azi >= 247.5 && azi < 292.5) aziDesc = "left profile view (270Â°)";
        else if (azi >= 292.5 && azi < 337.5) aziDesc = "front-left side view (315Â°)";

        // B. ä»°ä¿¯è§’ (Elevation)
        let eleDesc = "eye-level";
        if (ele > 60) eleDesc = "overhead top-down view";
        else if (ele > 30) eleDesc = "high angle view";
        else if (ele > 10) eleDesc = "slightly from above";
        else if (ele < -10) eleDesc = "slightly from below";
        else if (ele < -30) eleDesc = "low angle view";
        else if (ele < -60) eleDesc = "worm's eye view";

        // C. æ™¯åˆ« (Distance/Zoom)
        let zoom = camState.zoom;
        let distDesc = "medium shot";
        if (zoom > 1.8) distDesc = "face close-up";
        else if (zoom > 1.2) distDesc = "close-up";
        else if (zoom < 0.6) distDesc = "full body wide shot";

        // D. ç»„åˆï¼š[è§¦å‘è¯] [ç²¾ç¡®è§’åº¦], [è‡ªç„¶è§’åº¦], [ä¸»ä½“], [ä¸€è‡´æ€§çº¦æŸ]
        // å¾ˆå¤š LoRA ä½¿ç”¨ "view of [class] from [angle]" å¥å¼
        let subject = extraPrompt.value || "the character";
        
        // æ„é€  Final Prompt
        // 1. è§¦å‘è¯ (LoRA trigger)
        // 2. è§’åº¦æè¿° (æ··åˆäº†è‡ªç„¶è¯­è¨€å’Œæ•°å€¼ï¼Œå¢åŠ å‘½ä¸­ç‡)
        // 3. èµ„äº§å›ºå®šå’’è¯­ (Identical, reference based)
        let prompt = `<sks> view of ${subject}, ${aziDesc}, ${eleDesc}, ${distDesc}`;
        prompt += `, azimuth ${azi} degrees, elevation ${ele} degrees`; // å¢åŠ æ•°å­¦æè¿°ï¼Œå¾ˆå¤šæ¨¡å‹åƒè¿™ä¸€å¥—
        prompt += `, identical to reference, consistent identity, white background`;

        finalPrompt.innerText = prompt;
    }

    extraPrompt.addEventListener('input', generatePrecisionPrompt);

    window.resetCamera = () => {
        camState.azi = 0; camState.ele = 0; camState.panX = 0; camState.panY = 0; camState.zoom = 1.0;
        updateCameraVisuals();
    };

    // æäº¤é€»è¾‘
    const generateBtn = document.getElementById('generate-btn');
    const resultImg = document.getElementById('result-img');
    const loader = document.getElementById('loader');
    const emptyState = document.getElementById('empty-state');

    generateBtn.onclick = async () => {
        if (!fileInput.files[0]) { alert('è¯·å…ˆä¸Šä¼ å›ºå®šèµ„äº§ (åŸå›¾)'); return; }
        generateBtn.disabled = true; generateBtn.innerHTML = 'AI æ­£åœ¨è®¡ç®—...';
        loader.style.display = 'flex'; resultImg.style.display = 'none'; emptyState.style.display = 'none';

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        // ç›´æ¥ä½¿ç”¨ç²¾ç»†è®¡ç®—çš„ Prompt
        formData.append('prompt', finalPrompt.innerText);
        
        // ä¾ç„¶ä¼ æ•°å€¼ç»™åç«¯å¤‡æ¡ˆ
        formData.append('azimuth', uiAzi.innerText.replace('Â°',''));
        formData.append('elevation', uiEle.innerText.replace('Â°',''));
        
        const source = document.getElementById('model-select').value;
        formData.append('model_source', source);
        if (source === 'custom') {
            const cfg = JSON.parse(localStorage.getItem('ai_6dof_cfg') || '{}');
            formData.append('custom_api_url', cfg.url);
            formData.append('custom_api_key', cfg.key);
            formData.append('custom_model_name', cfg.model);
        }

        try {
            const res = await fetch('/generate', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) {
                const url = data.data.image_url || data.original_image;
                resultImg.src = url;
                resultImg.onload = () => { resultImg.style.display='block'; loader.style.display='none'; addToHistory(url); };
            } else { alert(data.error); loader.style.display = 'none'; }
        } catch (e) { alert('Net Error'); loader.style.display = 'none'; } 
        finally { generateBtn.disabled = false; generateBtn.innerHTML = '<i data-lucide="aperture"></i> ç«‹å³æ¸²æŸ“'; }
    };

    function addToHistory(url) {
        const d = document.createElement('div'); d.className = 'film-item'; d.innerHTML=`<img src="${url}">`;
        d.onclick=()=>resultImg.src=url; document.getElementById('filmstrip-track').prepend(d);
    }

    // Modal logic (Same as before)
    const modal = document.getElementById('config-modal');
    document.getElementById('config-btn').onclick = () => {
        const cfg = JSON.parse(localStorage.getItem('ai_6dof_cfg') || '{}');
        document.getElementById('cfg-url').value = cfg.url||'';
        document.getElementById('cfg-key').value = cfg.key||'';
        document.getElementById('cfg-model').value = cfg.model||'';
        modal.style.display='flex';
    }
    document.querySelector('.close-modal').onclick=()=>modal.style.display='none';
    document.getElementById('save-cfg-btn').onclick=()=>{
        localStorage.setItem('ai_6dof_cfg', JSON.stringify({
            url: document.getElementById('cfg-url').value,
            key: document.getElementById('cfg-key').value,
            model: document.getElementById('cfg-model').value
        }));
        modal.style.display='none';
    }
    
    // åˆå§‹åŒ–ä¸€æ¬¡ Prompt
    generatePrecisionPrompt();
</script>
</body>
</html>
