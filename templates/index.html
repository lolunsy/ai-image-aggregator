<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å¯¼æ¼”å·¥åŠ | å…¨è‡ªç”±åº¦ç©ºé—´</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=6.0">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<!-- é˜»æ­¢å³é”®é»˜è®¤èœå•ï¼Œä»¥ä¾¿ç”¨äºå¹³ç§»æ“ä½œ -->
<body oncontextmenu="return false;">

<header class="studio-header">
    <div class="brand">
        <div class="logo-box"><i data-lucide="move-3d"></i></div>
        <div class="brand-text">
            <h1>AI å¯¼æ¼”å·¥åŠ</h1>
            <span class="subtitle">å…¨è‡ªç”±åº¦ç©ºé—´æ‘„å½±æœº</span>
        </div>
    </div>
    <div class="header-controls">
        <button id="config-btn" class="tool-btn"><i data-lucide="settings"></i> <span>å…¨å±€è®¾ç½®</span></button>
    </div>
</header>

<div class="main-layout">
    
    <!-- å·¦ä¾§ï¼š3D äº¤äº’åŒº -->
    <aside class="control-panel">
        
        <!-- 1. ç´ æä¸Šä¼  -->
        <div class="panel-section">
            <div class="section-header"><i data-lucide="image"></i> <span>åœºæ™¯æ ¸å¿ƒ (Subject)</span></div>
            <div class="upload-widget" id="upload-zone">
                <input type="file" id="file-input" accept="image/*" hidden>
                <div id="upload-placeholder" class="placeholder-content">
                    <i data-lucide="upload-cloud"></i>
                    <p>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</p>
                </div>
                <img id="source-preview" class="hidden">
            </div>
        </div>

        <!-- 2. å…¨è‡ªç”±åº¦è§†å£ -->
        <div class="panel-section full-height">
            <div class="section-header">
                <div class="header-left">
                    <i data-lucide="camera"></i> <span>ç©ºé—´å–æ™¯å™¨</span>
                </div>
                <button class="reset-btn" onclick="resetCamera()">å¤ä½é•œå¤´</button>
            </div>
            
            <div class="viewport-3d" id="viewport-3d">
                <!-- æ“ä½œæŒ‡å¼•å±‚ -->
                <div class="instruction-overlay">
                    <div class="inst-item"><i data-lucide="mouse-pointer-2"></i> å·¦é”®æ—‹è½¬</div>
                    <div class="inst-item"><i data-lucide="move"></i> å³é”®å¹³ç§»</div>
                    <div class="inst-item"><i data-lucide="scroll"></i> æ»šè½®ç¼©æ”¾</div>
                </div>

                <!-- 3D åœºæ™¯å±‚çº§ï¼šPan -> Orbit -> Zoom -->
                <div class="cam-pan-layer" id="cam-pan">
                    <div class="cam-orbit-layer" id="cam-orbit">
                        <div class="cam-zoom-layer" id="cam-zoom">
                            
                            <!-- ç‰©ç†ä¸–ç•Œ -->
                            <div class="world-center">
                                <!-- åœ°é¢ç½‘æ ¼ -->
                                <div class="grid-floor">
                                    <div class="axis x-axis"></div>
                                    <div class="axis z-axis"></div>
                                    <div class="floor-label">FRONT</div>
                                </div>
                                
                                <!-- ä¸»è§’å¡ç‰‡ -->
                                <div class="subject-card">
                                    <img id="subject-img-3d" src="">
                                    <div class="no-subject">?</div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- HUD æ•°æ® -->
                <div class="hud-panel">
                    <div class="hud-row"><span>ROTATE H</span><span id="val-azi" class="accent">0Â°</span></div>
                    <div class="hud-row"><span>ROTATE V</span><span id="val-ele" class="accent">0Â°</span></div>
                    <div class="hud-row"><span>PAN X</span><span id="val-pan-x">0</span></div>
                    <div class="hud-row"><span>PAN Y</span><span id="val-pan-y">0</span></div>
                    <div class="hud-row"><span>ZOOM</span><span id="val-zoom">1.0</span></div>
                </div>
            </div>
        </div>
    </aside>

    <!-- å³ä¾§ï¼šæ¸²æŸ“ç»“æœ -->
    <main class="result-stage">
        <div class="prompt-monitor">
            <div class="monitor-label">SPATIAL PROMPT (ç©ºé—´æç¤ºè¯)</div>
            <div class="monitor-screen" id="final-prompt">&lt;sks&gt; front view, eye-level shot, medium shot</div>
            <input type="text" id="extra-prompt" class="extra-input" placeholder="åœ¨æ­¤è¡¥å……é£æ ¼æè¿° (å¦‚: cyberpunk, 8k, masterpiece)...">
        </div>

        <div class="canvas-wrapper">
            <div class="render-actions">
                <select id="model-select" class="model-select-dark">
                    <option value="preset">âš¡ é¢„è®¾æ¨¡å‹ (Fal/Qwen)</option>
                    <option value="custom">ğŸ›  è‡ªå®šä¹‰ API</option>
                </select>
                <button id="generate-btn" class="render-btn-large">
                    <i data-lucide="aperture"></i> æ¸²æŸ“è§†å›¾
                </button>
            </div>

            <div class="image-container">
                <div id="empty-state" class="empty-state">
                    <i data-lucide="monitor-dot"></i>
                    <p>è°ƒæ•´å·¦ä¾§ 3D é•œå¤´åç‚¹å‡»æ¸²æŸ“</p>
                </div>
                <div id="loader" class="loader" style="display: none;">
                    <div class="radar-spinner"></div>
                    <p>æ­£åœ¨é‡æ„ä¸‰ç»´è§†è§’...</p>
                </div>
                <img id="result-img" class="final-image" style="display: none;">
            </div>
        </div>

        <div class="filmstrip">
            <div class="filmstrip-track" id="filmstrip-track"></div>
        </div>
    </main>
</div>

<!-- API é…ç½®å¼¹çª— -->
<div id="config-modal" class="modal-backdrop">
    <div class="modal-panel">
        <div class="modal-header">
            <h3>API å…¨å±€é…ç½®</h3>
            <button class="close-modal"><i data-lucide="x"></i></button>
        </div>
        <div class="modal-body">
            <div class="input-group"><label>URL</label> <input type="text" id="cfg-url"></div>
            <div class="input-group"><label>Key</label> <input type="password" id="cfg-key"></div>
            <div class="input-group"><label>Model</label> <input type="text" id="cfg-model"></div>
        </div>
        <div class="modal-footer"><button id="save-cfg-btn" class="save-btn">ä¿å­˜</button></div>
    </div>
</div>

<script>
    lucide.createIcons();

    // 1. ç´ æä¸Šä¼ 
    const fileInput = document.getElementById('file-input');
    const sourcePreview = document.getElementById('source-preview');
    const subjectImg3D = document.getElementById('subject-img-3d');
    const placeholder = document.getElementById('upload-placeholder');
    const noSubject = document.querySelector('.no-subject');

    document.getElementById('upload-zone').onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                sourcePreview.src = e.target.result;
                sourcePreview.classList.remove('hidden');
                placeholder.style.display = 'none';
                subjectImg3D.src = e.target.result;
                subjectImg3D.style.display = 'block';
                noSubject.style.display = 'none';
            }
            reader.readAsDataURL(file);
        }
    };

    // --- 2. 3D æ‘„åƒæœºå…¨è‡ªç”±åº¦é€»è¾‘ (æ ¸å¿ƒ) ---
    // çŠ¶æ€å˜é‡
    const camState = {
        azi: 0,    // æ—‹è½¬ (Yè½´)
        ele: 0,    // ä¿¯ä»° (Xè½´)
        panX: 0,   // å¹³ç§» X
        panY: 0,   // å¹³ç§» Y
        zoom: 1.0  // ç¼©æ”¾ Z
    };

    // DOM å…ƒç´ 
    const viewport = document.getElementById('viewport-3d');
    const layerPan = document.getElementById('cam-pan');
    const layerOrbit = document.getElementById('cam-orbit');
    const layerZoom = document.getElementById('cam-zoom');
    
    // HUD
    const uiAzi = document.getElementById('val-azi');
    const uiEle = document.getElementById('val-ele');
    const uiPanX = document.getElementById('val-pan-x');
    const uiPanY = document.getElementById('val-pan-y');
    const uiZoom = document.getElementById('val-zoom');
    const finalPrompt = document.getElementById('final-prompt');

    // é¼ æ ‡çŠ¶æ€
    let isDragging = false;
    let dragMode = null; // 'orbit' (å·¦é”®) æˆ– 'pan' (å³é”®)
    let lastX = 0, lastY = 0;

    // A. é¼ æ ‡æŒ‰ä¸‹
    viewport.addEventListener('mousedown', (e) => {
        isDragging = true;
        lastX = e.clientX;
        lastY = e.clientY;

        // åˆ¤æ–­æŒ‰é”®ï¼š0=å·¦é”®, 2=å³é”®
        if (e.button === 0) {
            dragMode = 'orbit';
            viewport.style.cursor = 'grabbing';
        } else if (e.button === 2) {
            dragMode = 'pan';
            viewport.style.cursor = 'move';
        }
    });

    // B. é¼ æ ‡ç§»åŠ¨
    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const deltaX = e.clientX - lastX;
        const deltaY = e.clientY - lastY;
        lastX = e.clientX;
        lastY = e.clientY;

        if (dragMode === 'orbit') {
            // æ—‹è½¬é€»è¾‘
            camState.azi += deltaX * 0.5;
            camState.ele -= deltaY * 0.5;
            // é™åˆ¶ä¿¯ä»°è§’ï¼Œé¿å…ç¿»è½¬
            camState.ele = Math.max(-85, Math.min(85, camState.ele));
        } else if (dragMode === 'pan') {
            // å¹³ç§»é€»è¾‘ (åå‘ç§»åŠ¨åœºæ™¯ = æ‘„åƒæœºç§»åŠ¨)
            camState.panX += deltaX;
            camState.panY += deltaY; 
        }

        updateCameraVisuals();
    });

    // C. é¼ æ ‡æ¾å¼€
    window.addEventListener('mouseup', () => {
        isDragging = false;
        dragMode = null;
        viewport.style.cursor = 'grab';
    });

    // D. æ»šè½®ç¼©æ”¾
    viewport.addEventListener('wheel', (e) => {
        e.preventDefault();
        // æ»šè½®å‘ä¸‹(æ­£)æ˜¯ç¼©å°ï¼Œå‘ä¸Š(è´Ÿ)æ˜¯æ”¾å¤§
        const zoomSpeed = 0.001 * camState.zoom; // åŸºäºå½“å‰zoomçš„é€Ÿç‡
        camState.zoom -= e.deltaY * 0.001; 
        
        // é™åˆ¶ç¼©æ”¾èŒƒå›´
        camState.zoom = Math.max(0.2, Math.min(3.0, camState.zoom));
        
        updateCameraVisuals();
    }, { passive: false });

    // æ ¸å¿ƒæ¸²æŸ“å‡½æ•°ï¼šåº”ç”¨ CSS å˜æ¢
    function updateCameraVisuals() {
        // 1. å¹³ç§»å±‚ (Translate X/Y)
        layerPan.style.transform = `translateX(${camState.panX}px) translateY(${camState.panY}px)`;
        
        // 2. æ—‹è½¬å±‚ (Rotate Y/X)
        // æ³¨æ„ï¼šrotateX æ­£å€¼æ˜¯è®©åœºæ™¯å‘åå€’ï¼ˆæˆ‘ä»¬çœ‹ä¸Šé¢ï¼‰ï¼ŒrotateY æ­£å€¼æ˜¯åœºæ™¯é¡ºæ—¶é’ˆï¼ˆæˆ‘ä»¬çœ‹å·¦è¾¹ï¼‰
        layerOrbit.style.transform = `rotateX(${camState.ele}deg) rotateY(${camState.azi}deg)`;
        
        // 3. ç¼©æ”¾å±‚ (Scale)
        layerZoom.style.transform = `scale(${camState.zoom})`;

        // 4. æ›´æ–° HUD
        updateHUD();
        // 5. æ›´æ–° Prompt
        generatePrompt();
    }

    function updateHUD() {
        // è§„èŒƒåŒ–è§’åº¦æ˜¾ç¤º (-180 ~ 180)
        let dispAzi = Math.round(camState.azi % 360);
        if (dispAzi > 180) dispAzi -= 360;
        if (dispAzi < -180) dispAzi += 360;

        uiAzi.innerText = `${dispAzi}Â°`;
        uiEle.innerText = `${Math.round(camState.ele)}Â°`;
        uiPanX.innerText = Math.round(camState.panX);
        uiPanY.innerText = Math.round(camState.panY);
        uiZoom.innerText = camState.zoom.toFixed(2) + 'x';
    }

    function generatePrompt() {
        const azi = parseInt(uiAzi.innerText);
        const ele = parseInt(uiEle.innerText);
        const zoom = camState.zoom;

        let parts = [];
        
        // Azimuth Logic
        if (azi > -20 && azi < 20) parts.push("front view");
        else if (azi >= 20 && azi < 70) parts.push("front-left side view");
        else if (azi >= 70 && azi < 110) parts.push("left side profile view");
        else if (azi >= 110 && azi < 160) parts.push("back-left view");
        else if (azi >= 160 || azi <= -160) parts.push("back view");
        else if (azi <= -20 && azi > -70) parts.push("front-right side view");
        else if (azi <= -70 && azi > -110) parts.push("right side profile view");
        else if (azi <= -110 && azi > -160) parts.push("back-right view");

        // Elevation Logic
        if (ele > 40) parts.push("top-down view");
        else if (ele > 15) parts.push("high angle shot");
        else if (ele < -15) parts.push("low angle shot");
        else parts.push("eye-level shot");

        // Zoom Logic
        if (zoom > 1.8) parts.push("extreme close-up");
        else if (zoom > 1.2) parts.push("close-up shot");
        else if (zoom < 0.6) parts.push("wide angle full body shot");
        else parts.push("medium shot");

        finalPrompt.innerText = `<sks> ${parts.join(", ")}`;
    }

    window.resetCamera = () => {
        camState.azi = 0; camState.ele = 0;
        camState.panX = 0; camState.panY = 0;
        camState.zoom = 1.0;
        updateCameraVisuals();
    };

    // åˆå§‹åŒ–
    updateCameraVisuals();

    // --- 3. æäº¤ç”Ÿæˆ ---
    const generateBtn = document.getElementById('generate-btn');
    const resultImg = document.getElementById('result-img');
    const loader = document.getElementById('loader');
    const emptyState = document.getElementById('empty-state');

    generateBtn.onclick = async () => {
        if (!fileInput.files[0]) { alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡'); return; }
        
        generateBtn.disabled = true;
        generateBtn.innerHTML = 'æ¸²æŸ“ä¸­...';
        loader.style.display = 'flex';
        resultImg.style.display = 'none';
        emptyState.style.display = 'none';

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        formData.append('prompt', finalPrompt.innerText + ", " + document.getElementById('extra-prompt').value);
        
        // å‘é€æ‰€æœ‰ 6DoF å‚æ•° (ä¾›åç«¯ä½¿ç”¨)
        formData.append('azimuth', uiAzi.innerText.replace('Â°',''));
        formData.append('elevation', uiEle.innerText.replace('Â°',''));
        formData.append('zoom', camState.zoom);
        formData.append('pan_x', camState.panX);
        formData.append('pan_y', camState.panY);
        
        const source = document.getElementById('model-select').value;
        formData.append('model_source', source);
        if (source === 'custom') {
            const cfg = JSON.parse(localStorage.getItem('ai_6dof_cfg') || '{}');
            formData.append('custom_api_url', cfg.url);
            formData.append('custom_api_key', cfg.key);
            formData.append('custom_model_name', cfg.model);
        }

        try {
            const res = await fetch('/generate', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) {
                const url = data.data.image_url || data.original_image;
                resultImg.src = url;
                resultImg.onload = () => { resultImg.style.display='block'; loader.style.display='none'; addToHistory(url); };
            } else {
                alert('Err: ' + (data.error));
                loader.style.display = 'none';
            }
        } catch (e) {
            console.error(e);
            alert('Net Error');
            loader.style.display = 'none';
        } finally {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i data-lucide="aperture"></i> æ¸²æŸ“è§†å›¾';
        }
    };

    function addToHistory(url) {
        const d = document.createElement('div');
        d.className = 'film-item'; d.innerHTML=`<img src="${url}">`;
        d.onclick=()=>resultImg.src=url;
        document.getElementById('filmstrip-track').prepend(d);
    }

    // Config
    const modal = document.getElementById('config-modal');
    document.getElementById('config-btn').onclick = () => {
        const cfg = JSON.parse(localStorage.getItem('ai_6dof_cfg') || '{}');
        document.getElementById('cfg-url').value = cfg.url||'';
        document.getElementById('cfg-key').value = cfg.key||'';
        document.getElementById('cfg-model').value = cfg.model||'';
        modal.style.display='flex';
    }
    document.querySelector('.close-modal').onclick=()=>modal.style.display='none';
    document.getElementById('save-cfg-btn').onclick=()=>{
        localStorage.setItem('ai_6dof_cfg', JSON.stringify({
            url: document.getElementById('cfg-url').value,
            key: document.getElementById('cfg-key').value,
            model: document.getElementById('cfg-model').value
        }));
        modal.style.display='none';
    }
</script>
</body>
</html>
