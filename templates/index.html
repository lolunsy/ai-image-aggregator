<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å¯¼æ¼”å·¥åŠ | ä¸‰ç»´ç©ºé—´è¿é•œç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=4.0">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<!-- é¡¶éƒ¨å¯¼èˆª -->
<header class="studio-header">
    <div class="brand">
        <div class="logo-box"><i data-lucide="clapperboard"></i></div>
        <div class="brand-text">
            <h1>AI å¯¼æ¼”å·¥åŠ</h1>
            <span class="subtitle">ä¸‰ç»´ç©ºé—´æ‘„å½±æœºè°ƒåº¦ç³»ç»Ÿ</span>
        </div>
    </div>
    <div class="header-controls">
        <button id="config-btn" class="tool-btn">
            <i data-lucide="settings"></i> <span>API å…¨å±€é…ç½®</span>
        </button>
    </div>
</header>

<div class="main-layout">
    
    <!-- å·¦ä¾§ï¼š3D è¿é•œæ§åˆ¶å° -->
    <aside class="control-panel">
        
        <!-- 1. æ ¸å¿ƒç´ æ -->
        <div class="panel-section">
            <div class="section-header"><i data-lucide="box"></i> <span>åœºæ™¯ä¸»è§’ (Subject)</span></div>
            <div class="upload-widget" id="upload-zone">
                <input type="file" id="file-input" accept="image/*" hidden>
                <div id="upload-placeholder" class="placeholder-content">
                    <i data-lucide="upload-cloud"></i>
                    <p>ç‚¹å‡»ä¸Šä¼ è§’è‰²/ç‰©ä½“å›¾ç‰‡</p>
                </div>
                <img id="source-preview" class="hidden">
            </div>
        </div>

        <!-- 2. ä¸‰ç»´å¯è§†åŒ–è¿é•œ (æ ¸å¿ƒåŠŸèƒ½) -->
        <div class="panel-section full-height">
            <div class="section-header">
                <i data-lucide="axis-3d"></i> <span>ç©ºé—´æ‘„åƒæœºè½¨é“</span>
                <span class="tech-tag">3D VIEW</span>
            </div>
            
            <!-- 3D èˆå° -->
            <div class="scene-container">
                <div class="scene-stage" id="scene-stage">
                    <!-- åœ°é¢ç½‘æ ¼ -->
                    <div class="grid-floor"></div>
                    
                    <!-- ä¸­å¿ƒä¸»è§’ (Billboard) -->
                    <div class="subject-wrapper">
                        <div class="subject-plane">
                            <img id="subject-img-3d" src="" alt="Subject">
                            <div class="subject-placeholder">?</div>
                        </div>
                    </div>

                    <!-- æ‘„åƒæœºè½¨é“ç³»ç»Ÿ -->
                    <div class="camera-orbit-system" id="orbit-system">
                        <!-- æ‘„åƒæœºè¿çº¿ -->
                        <div class="camera-line"></div>
                        <!-- æ‘„åƒæœºæœ¬ä½“ -->
                        <div class="camera-gizmo">
                            <div class="cam-body"></div>
                            <div class="cam-lens"></div>
                        </div>
                    </div>
                </div>
                
                <!-- è§†è§’æ–¹ä½æŒ‡ç¤ºå™¨ (HUD) -->
                <div class="hud-overlay">
                    <div class="hud-item top-left">
                        <span class="hud-label">Azimuth (æ–¹ä½è§’)</span>
                        <span class="hud-val" id="disp-azimuth">0Â°</span>
                    </div>
                    <div class="hud-item top-right">
                        <span class="hud-label">Elevation (ä»°è§’)</span>
                        <span class="hud-val" id="disp-elevation">0Â°</span>
                    </div>
                    <div class="hud-item bottom-left">
                        <span class="hud-label">Distance (è·ç¦»)</span>
                        <span class="hud-val" id="disp-distance">2.0m</span>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶æ»‘æ† -->
            <div class="controls-grid">
                <!-- æ–¹ä½è§’ -->
                <div class="control-item">
                    <div class="control-label">
                        <span><i data-lucide="refresh-cw"></i> Azimuth (ç¯ç»•)</span>
                    </div>
                    <input type="range" id="azimuth-slider" min="0" max="360" value="0">
                    <div class="tick-marks">
                        <span>Front</span><span>Right</span><span>Back</span><span>Left</span><span>Front</span>
                    </div>
                </div>

                <!-- ä»°è§’ -->
                <div class="control-item">
                    <div class="control-label">
                        <span><i data-lucide="move-vertical"></i> Elevation (é«˜ä½)</span>
                    </div>
                    <input type="range" id="elevation-slider" min="-10" max="90" value="0">
                    <div class="tick-marks">
                        <span>Low</span><span>Eye</span><span>High</span><span>Top</span>
                    </div>
                </div>

                <!-- è·ç¦» -->
                <div class="control-item">
                    <div class="control-label">
                        <span><i data-lucide="maximize"></i> Distance (æ™¯åˆ«)</span>
                    </div>
                    <input type="range" id="distance-slider" min="1" max="10" step="0.1" value="2.5">
                    <div class="tick-marks">
                        <span>Close</span><span>Medium</span><span>Wide</span>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- å³ä¾§ï¼šæ¸²æŸ“ç»“æœ -->
    <main class="result-stage">
        <!-- è‡ªåŠ¨ç”Ÿæˆçš„ Prompt æ˜¾ç¤ºåŒº -->
        <div class="prompt-monitor">
            <div class="monitor-label">GENERATED PROMPT / ç©ºé—´æç¤ºè¯</div>
            <div class="monitor-screen" id="final-prompt">&lt;sks&gt; front view, eye-level shot, medium shot</div>
            <input type="text" id="extra-prompt" class="extra-input" placeholder="åœ¨æ­¤è¡¥å……é£æ ¼æè¿° (å¦‚: cyberpunk, 8k, masterpiece)...">
        </div>

        <div class="canvas-wrapper">
            <div class="render-actions">
                <select id="model-select" class="model-select-dark">
                    <option value="preset">ğŸš€ é¢„è®¾æ¨¡å‹ (Fal/Qwen)</option>
                    <option value="custom">ğŸ›  è‡ªå®šä¹‰ API (OpenAI/Google)</option>
                </select>
                <button id="generate-btn" class="render-btn-large">
                    <i data-lucide="aperture"></i> æ¸²æŸ“è§†å›¾
                </button>
            </div>

            <div class="image-container">
                <div id="empty-state" class="empty-state">
                    <i data-lucide="monitor-play"></i>
                    <p>å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æ¸²æŸ“æŒ‡ä»¤</p>
                </div>
                <div id="loader" class="loader" style="display: none;">
                    <div class="radar-spinner"></div>
                    <p>æ­£åœ¨è®¡ç®—ç©ºé—´å…‰å½±...</p>
                </div>
                <img id="result-img" class="final-image" style="display: none;">
                
                <div class="viewport-tools">
                    <button onclick="downloadCurrent()"><i data-lucide="download"></i></button>
                    <button onclick="clearStage()"><i data-lucide="x-circle"></i></button>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å†å²è®°å½• -->
        <div class="filmstrip">
            <div class="filmstrip-track" id="filmstrip-track"></div>
        </div>
    </main>
</div>

<!-- API é…ç½®å¼¹çª— -->
<div id="config-modal" class="modal-backdrop">
    <div class="modal-panel">
        <div class="modal-header">
            <div class="modal-title"><i data-lucide="server"></i> <span>API å…¨å±€é…ç½®</span></div>
            <button class="close-modal"><i data-lucide="x"></i></button>
        </div>
        <div class="modal-body">
            <div class="config-desc">é…ç½®ç¬¬ä¸‰æ–¹æ¨¡å‹æ¥å£ (å…¼å®¹ OpenAI æ ¼å¼æˆ– Fal.ai)</div>
            <div class="input-group">
                <label>API Base URL</label>
                <input type="text" id="cfg-url" placeholder="https://api.openai.com/v1">
            </div>
            <div class="input-group">
                <label>API Key</label>
                <input type="password" id="cfg-key" placeholder="sk-...">
            </div>
            <div class="input-group">
                <label>Model Name</label>
                <input type="text" id="cfg-model" placeholder="gpt-4-vision-preview">
            </div>
        </div>
        <div class="modal-footer">
            <button id="save-cfg-btn" class="save-btn">ä¿å­˜é…ç½®</button>
        </div>
    </div>
</div>

<script>
    lucide.createIcons();

    // --- 1. å›¾ç‰‡å¤„ç† ---
    const fileInput = document.getElementById('file-input');
    const sourcePreview = document.getElementById('source-preview');
    const subjectImg3D = document.getElementById('subject-img-3d');
    const placeholder = document.getElementById('upload-placeholder');
    const subjectPlaceholder = document.querySelector('.subject-placeholder');

    document.getElementById('upload-zone').onclick = () => fileInput.click();

    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                sourcePreview.src = e.target.result;
                sourcePreview.classList.remove('hidden');
                placeholder.style.display = 'none';
                
                // 3D åœºæ™¯ä¸­çš„ä¸»è§’
                subjectImg3D.src = e.target.result;
                subjectImg3D.style.display = 'block';
                subjectPlaceholder.style.display = 'none';
            }
            reader.readAsDataURL(file);
        }
    };

    // --- 2. 3D æ‘„åƒæœºè½¨é“é€»è¾‘ (æ ¸å¿ƒ) ---
    const aziSlider = document.getElementById('azimuth-slider');
    const eleSlider = document.getElementById('elevation-slider');
    const distSlider = document.getElementById('distance-slider');
    
    const sceneStage = document.getElementById('scene-stage');
    const orbitSystem = document.getElementById('orbit-system');
    const cameraGizmo = document.querySelector('.camera-gizmo');
    const cameraLine = document.querySelector('.camera-line');

    const dispAzi = document.getElementById('disp-azimuth');
    const dispEle = document.getElementById('disp-elevation');
    const dispDist = document.getElementById('disp-distance');
    const finalPrompt = document.getElementById('final-prompt');

    function update3DScene() {
        const azi = parseInt(aziSlider.value); // 0 - 360
        const ele = parseInt(eleSlider.value); // -10 - 90
        const dist = parseFloat(distSlider.value); // 1.0 - 10.0

        // æ›´æ–° HUD æ•°å€¼
        dispAzi.innerText = `${azi}Â°`;
        dispEle.innerText = `${ele}Â°`;
        dispDist.innerText = `${dist.toFixed(1)}m`;

        // 1. æ—‹è½¬æ•´ä¸ªèˆå°æ¥æ¨¡æ‹Ÿæ‘„åƒæœºç¯ç»• (æ›´ç›´è§‚ï¼Œä¸»è§’ä¸åŠ¨ï¼Œæ‘„åƒæœºåŠ¨)
        // å®é™…ä¸Šåœ¨ CSS 3D ä¸­ï¼Œæ—‹è½¬çˆ¶å®¹å™¨ orbitSystem æœ€å®¹æ˜“å®ç°
        // Azimuth (Yè½´æ—‹è½¬), Elevation (Zè½´/Xè½´æ—‹è½¬ï¼Œå–å†³äºåæ ‡ç³»)
        
        // æˆ‘ä»¬è®©è½¨é“ç³»ç»Ÿæ—‹è½¬
        // transform: rotateY(azi) rotateX(-ele)
        // æ³¨æ„ï¼šCSS çš„æ—‹è½¬æ–¹å‘å¯èƒ½éœ€è¦å¾®è°ƒä»¥åŒ¹é…ç›´è§‰
        orbitSystem.style.transform = `rotateY(${azi}deg) rotateX(${-ele}deg)`;

        // 2. è·ç¦»æ§åˆ¶ (Camera Translation)
        // æ‘„åƒæœºåœ¨ Z è½´ä¸Šç§»åŠ¨ (è¿œç¦»ä¸­å¿ƒ)
        // åŸºç¡€è·ç¦» 100px + dist * 30px
        const zDistance = 60 + (dist * 25);
        cameraGizmo.style.transform = `translateZ(${zDistance}px) rotateX(90deg)`; 
        // rotateX(90deg) æ˜¯ä¸ºäº†è®©é”¥ä½“æŒ‡å‘ä¸­å¿ƒ
        
        // æ›´æ–°è¿çº¿é•¿åº¦
        cameraLine.style.width = `${zDistance}px`;
        cameraLine.style.transform = `rotateY(90deg) translateX(${zDistance/2}px)`; // ç¨å¾®å¤æ‚ä¸€ç‚¹çš„å®šä½

        // 3. æ›´æ–°æç¤ºè¯
        updatePromptText(azi, ele, dist);
    }

    function updatePromptText(azi, ele, dist) {
        let p_azi = "front view";
        let p_ele = "eye-level shot";
        let p_dist = "medium shot";

        // Azimuth Logic (Based on 0 = Front)
        if (azi > 315 || azi <= 45) p_azi = "front view";
        else if (azi > 45 && azi <= 135) p_azi = "right side view";
        else if (azi > 135 && azi <= 225) p_azi = "back view";
        else if (azi > 225 && azi <= 315) p_azi = "left side view";

        // Elevation Logic
        if (ele > 60) p_ele = "top-down view (overhead)";
        else if (ele > 20) p_ele = "high angle (elevated shot)";
        else if (ele < -5) p_ele = "low angle (worm's eye view)";
        else p_ele = "eye-level shot";

        // Distance Logic
        if (dist < 2.5) p_dist = "close-up shot";
        else if (dist > 6.0) p_dist = "wide angle full body shot";
        else p_dist = "medium shot";

        // ç»„åˆ Prompt (å‚è€ƒä½ çš„æˆªå›¾æ ¼å¼)
        finalPrompt.innerText = `<sks> ${p_azi}, ${p_ele}, ${p_dist}`;
    }

    // äº‹ä»¶ç›‘å¬
    aziSlider.addEventListener('input', update3DScene);
    eleSlider.addEventListener('input', update3DScene);
    distSlider.addEventListener('input', update3DScene);
    
    // åˆå§‹åŒ–
    update3DScene();


    // --- 3. ç”Ÿæˆé€»è¾‘ ---
    const generateBtn = document.getElementById('generate-btn');
    const resultImg = document.getElementById('result-img');
    const loader = document.getElementById('loader');
    const emptyState = document.getElementById('empty-state');
    const filmstrip = document.getElementById('filmstrip-track');

    generateBtn.onclick = async () => {
        if (!fileInput.files[0]) {
            alert('è¯·å…ˆä¸Šä¼ åœºæ™¯ä¸»è§’å›¾ç‰‡');
            return;
        }

        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i data-lucide="loader" class="spin"></i> è®¡ç®—ä¸­...';
        loader.style.display = 'flex';
        resultImg.style.display = 'none';
        emptyState.style.display = 'none';

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        
        // ç»„åˆå®Œæ•´çš„ Prompt
        const basePrompt = finalPrompt.innerText;
        const userExtra = document.getElementById('extra-prompt').value;
        formData.append('prompt', `${basePrompt}, ${userExtra}`);
        
        // ä¼ é€’æ•°å€¼å‚æ•° (ä¾›åç«¯è®°å½•æˆ–å¾®è°ƒ)
        formData.append('azimuth', aziSlider.value);
        formData.append('elevation', eleSlider.value);
        formData.append('distance', distSlider.value);
        
        // API é…ç½®
        const source = document.getElementById('model-select').value;
        formData.append('model_source', source);
        if (source === 'custom') {
            const cfg = JSON.parse(localStorage.getItem('ai_director_cfg_v2') || '{}');
            if(!cfg.url || !cfg.key) {
                alert('è¯·åœ¨å³ä¸Šè§’é…ç½® API');
                resetBtn();
                return;
            }
            formData.append('custom_api_url', cfg.url);
            formData.append('custom_api_key', cfg.key);
            formData.append('custom_model_name', cfg.model);
        }

        try {
            const res = await fetch('/generate', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.success) {
                const url = data.data.image_url || data.original_image;
                resultImg.src = url;
                resultImg.onload = () => {
                    resultImg.style.display = 'block';
                    loader.style.display = 'none';
                    addToHistory(url);
                };
            } else {
                alert('ç”Ÿæˆå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                loader.style.display = 'none';
                emptyState.style.display = 'flex';
            }
        } catch (e) {
            console.error(e);
            alert('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            loader.style.display = 'none';
        } finally {
            resetBtn();
        }
    };

    function resetBtn() {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i data-lucide="aperture"></i> æ¸²æŸ“è§†å›¾';
    }

    function addToHistory(url) {
        const div = document.createElement('div');
        div.className = 'film-item';
        div.innerHTML = `<img src="${url}">`;
        div.onclick = () => resultImg.src = url;
        document.getElementById('filmstrip-track').prepend(div);
    }

    // --- 4. é…ç½®å¼¹çª— ---
    const modal = document.getElementById('config-modal');
    document.getElementById('config-btn').onclick = () => {
        const cfg = JSON.parse(localStorage.getItem('ai_director_cfg_v2') || '{}');
        document.getElementById('cfg-url').value = cfg.url || '';
        document.getElementById('cfg-key').value = cfg.key || '';
        document.getElementById('cfg-model').value = cfg.model || '';
        modal.style.display = 'flex';
    };
    document.querySelector('.close-modal').onclick = () => modal.style.display = 'none';
    document.getElementById('save-cfg-btn').onclick = () => {
        const cfg = {
            url: document.getElementById('cfg-url').value,
            key: document.getElementById('cfg-key').value,
            model: document.getElementById('cfg-model').value
        };
        localStorage.setItem('ai_director_cfg_v2', JSON.stringify(cfg));
        modal.style.display = 'none';
        alert('é…ç½®å·²ä¿å­˜');
    };
    window.downloadCurrent = () => { if(resultImg.src) { const a = document.createElement('a'); a.href=resultImg.src; a.download='render.png'; a.click(); }};
    window.clearStage = () => { resultImg.style.display='none'; emptyState.style.display='flex'; };

</script>
</body>
</html>
