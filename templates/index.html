<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 视角控制器</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<div class="container">
    <!-- 左侧控制面板 -->
    <div class="control-panel">
        <h2>PARAMETERS</h2>
        
        <form id="generate-form">
            <div class="form-group">
                <label>MODEL / 模型</label>
                <select name="model_name">
                    {% for name, id in models.items() %}
                    <option value="{{ name }}">{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>SOURCE IMAGE / 源图片</label>
                <input type="file" name="image" id="file-input" accept="image/*" required>
            </div>

            <!-- 摇杆交互区 -->
            <div class="form-group">
                <label>CAMERA ANGLE / 视角控制</label>
                <div class="joystick-container">
                    <div class="joystick-pad" id="joystick-pad">
                        <div class="crosshair-h"></div>
                        <div class="crosshair-v"></div>
                        <div class="joystick-handle" id="joystick-handle"></div>
                    </div>
                    
                    <div class="coords-display">
                        <div class="coord-box">HOR: <span id="val-h">0</span>°</div>
                        <div class="coord-box">VER: <span id="val-v">0</span>°</div>
                        <div class="coord-box">ZOOM: <span id="val-z">5.0</span></div>
                    </div>

                    <div class="zoom-control">
                        <label style="font-size: 0.8rem;">ZOOM LEVEL</label>
                        <input type="range" id="zoom-slider" min="0" max="100" value="50">
                    </div>

                    <!-- 隐藏的 Input，用于提交给后端 -->
                    <input type="hidden" name="h_angle" id="input-h" value="0">
                    <input type="hidden" name="v_angle" id="input-v" value="0">
                    <input type="hidden" name="zoom" id="input-z" value="50">
                </div>
            </div>

            <div class="form-group">
                <label>PROMPT / 提示词</label>
                <input type="text" name="prompt" placeholder="Describe the subject...">
            </div>

            <button type="submit" class="submit-btn" id="submit-btn">GENERATE</button>
        </form>
    </div>

    <!-- 右侧结果面板 -->
    <div class="result-panel">
        <h2>PREVIEW</h2>
        <div id="loading" class="loading-spinner"></div>
        
        <div id="content-area" style="text-align: center; width: 100%;">
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <div>
                    <p style="color:#666">Original</p>
                    <img id="original-preview" class="preview-img" style="display: none;">
                </div>
                <div>
                    <p style="color:var(--accent-color)">Result</p>
                    <img id="result-img" class="result-img" style="display: none;">
                </div>
            </div>
            <p id="status-text" style="margin-top: 20px; color: #888;">Ready to generate.</p>
        </div>
    </div>
</div>

<script>
    // --- 摇杆交互逻辑 ---
    const pad = document.getElementById('joystick-pad');
    const handle = document.getElementById('joystick-handle');
    const valH = document.getElementById('val-h');
    const valV = document.getElementById('val-v');
    const inputH = document.getElementById('input-h');
    const inputV = document.getElementById('input-v');
    
    let isDragging = false;
    const radius = 100; // pad width / 2

    // 更新位置和数值函数
    function updateJoystick(x, y) {
        // 限制在圆形范围内
        const distance = Math.sqrt(x*x + y*y);
        const maxDist = radius - 10; // 减去 handle 半径
        
        if (distance > maxDist) {
            const angle = Math.atan2(y, x);
            x = Math.cos(angle) * maxDist;
            y = Math.sin(angle) * maxDist;
        }

        // 移动 Handle (CSS transform)
        // 注意：x, y 是相对于中心的坐标
        handle.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;

        // 计算角度数值 (-180 到 180)
        // 映射：X轴 (-radius ~ +radius) -> (-180 ~ 180)
        // 映射：Y轴 (-radius ~ +radius) -> (90 ~ -90) 注意Y轴向上是正还是负
        
        const hAngle = Math.round((x / maxDist) * 180);
        const vAngle = Math.round((y / maxDist) * -90); // 向上拖动Y为负，但通常我们认为那是正仰角，所以取反

        // 更新显示和 Input
        valH.innerText = hAngle;
        valV.innerText = vAngle;
        inputH.value = hAngle;
        inputV.value = vAngle;
    }

    // 鼠标事件监听
    pad.addEventListener('mousedown', (e) => {
        isDragging = true;
        handleMouseMove(e);
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        handleMouseMove(e);
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
        // 可选：松开后是否回弹？截图中的功能通常不回弹，保持设定
    });

    function handleMouseMove(e) {
        const rect = pad.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        const x = e.clientX - centerX;
        const y = e.clientY - centerY;
        
        updateJoystick(x, y);
    }

    // --- 缩放滑块逻辑 ---
    const zoomSlider = document.getElementById('zoom-slider');
    const valZ = document.getElementById('val-z');
    const inputZ = document.getElementById('input-z');

    zoomSlider.addEventListener('input', (e) => {
        const val = e.target.value;
        // 简单的映射 0-100 到 1.0 - 10.0 的视觉数值
        const visualZoom = (val / 10).toFixed(1);
        valZ.innerText = visualZoom;
        inputZ.value = val;
    });

    // --- 图片上传预览 ---
    const fileInput = document.getElementById('file-input');
    const originalPreview = document.getElementById('original-preview');

    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                originalPreview.src = e.target.result;
                originalPreview.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }
    });

    // --- 表单提交逻辑 (AJAX) ---
    document.getElementById('generate-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submit-btn');
        const loading = document.getElementById('loading');
        const statusText = document.getElementById('status-text');
        const resultImg = document.getElementById('result-img');

        submitBtn.disabled = true;
        loading.style.display = 'block';
        statusText.innerText = "Processing on server...";
        resultImg.style.display = 'none';

        const formData = new FormData(this);

        try {
            const response = await fetch('/generate', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                statusText.innerText = "Generation Complete!";
                if (data.data.image_url) {
                    resultImg.src = data.data.image_url;
                    resultImg.style.display = 'block';
                } else {
                    statusText.innerText = data.data.message || "Done (No image returned)";
                }
            } else {
                statusText.innerText = "Error: " + data.error;
            }
        } catch (err) {
            statusText.innerText = "Network Error";
            console.error(err);
        } finally {
            submitBtn.disabled = false;
            loading.style.display = 'none';
        }
    });
</script>

</body>
</html>
