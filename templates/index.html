<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å¯¼æ¼”å·¥åŠ | æ™ºèƒ½è¿é•œç³»ç»Ÿ</title>
    <!-- å¼ºåˆ¶æ›´æ–° CSS ç‰ˆæœ¬é˜²æ­¢ç¼“å­˜ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=3.0">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<!-- é¡¶éƒ¨å¯¼èˆª -->
<header class="studio-header">
    <div class="brand">
        <div class="logo-box">
            <i data-lucide="clapperboard"></i>
        </div>
        <div class="brand-text">
            <h1>AI å¯¼æ¼”å·¥åŠ</h1>
            <span class="subtitle">æ™ºèƒ½è§†è§‰æ§åˆ¶å°</span>
        </div>
    </div>
    <div class="header-controls">
        <button id="config-btn" class="tool-btn">
            <i data-lucide="settings"></i> <span>å…¨å±€è®¾ç½®</span>
        </button>
    </div>
</header>

<div class="main-layout">
    
    <!-- å·¦ä¾§ï¼šæ§åˆ¶å° -->
    <aside class="control-panel">
        
        <!-- 1. ç´ æä¸Šä¼ åŒº -->
        <div class="panel-section">
            <div class="section-header">
                <i data-lucide="image"></i> <span>æ ¸å¿ƒç´ æ</span>
            </div>
            <div class="upload-widget" id="upload-zone">
                <input type="file" id="file-input" accept="image/*" hidden>
                <div id="upload-placeholder" class="placeholder-content">
                    <i data-lucide="upload-cloud"></i>
                    <p>ç‚¹å‡»ä¸Šä¼ è§’è‰²åŸå›¾</p>
                </div>
                <img id="source-preview" class="hidden">
            </div>
        </div>

        <!-- 2. å¯è§†åŒ–è¿é•œæ§åˆ¶ (æ ¸å¿ƒåŠŸèƒ½) -->
        <div class="panel-section">
            <div class="section-header">
                <i data-lucide="camera"></i> <span>è¿é•œæ§åˆ¶å°</span>
            </div>
            
            <!-- æ¨¡æ‹Ÿå–æ™¯å™¨ -->
            <div class="camera-viewport">
                <div class="viewport-overlay">
                    <span class="guide-line h-line"></span>
                    <span class="guide-line v-line"></span>
                </div>
                <!-- è¿™å¼ å›¾ä¼šéšç€æ§åˆ¶æ†å˜åŒ– -->
                <img id="manipulate-img" src="" alt="è¯·å…ˆä¸Šä¼ å›¾ç‰‡">
                <div class="no-image-hint">æ— ä¿¡å·</div>
            </div>

            <!-- æ§åˆ¶æ†åŒºåŸŸ -->
            <div class="controls-grid">
                <!-- æ—‹è½¬ -->
                <div class="control-item">
                    <div class="control-label">
                        <span><i data-lucide="rotate-cw"></i> ç¯ç»•æ—‹è½¬</span>
                        <span id="val-rotate" class="val-tag">0Â°</span>
                    </div>
                    <input type="range" id="rotate-slider" min="-180" max="180" value="0">
                </div>

                <!-- å‚ç›´å¹³ç§» (æ¨¡æ‹Ÿä¿¯ä»°) -->
                <div class="control-item">
                    <div class="control-label">
                        <span><i data-lucide="move-vertical"></i> ä¿¯ä»°è§’åº¦</span>
                        <span id="val-pan-y" class="val-tag">0%</span>
                    </div>
                    <input type="range" id="pan-y-slider" min="-50" max="50" value="0">
                </div>

                <!-- ç¼©æ”¾ -->
                <div class="control-item">
                    <div class="control-label">
                        <span><i data-lucide="zoom-in"></i> é•œå¤´æ¨æ‹‰</span>
                        <span id="val-zoom" class="val-tag">1.0x</span>
                    </div>
                    <input type="range" id="zoom-slider" min="0" max="100" value="50">
                </div>
            </div>
        </div>

        <!-- 3. æ™ºèƒ½æç¤ºè¯å›æ˜¾ -->
        <div class="panel-section">
            <div class="section-header">
                <i data-lucide="sparkles"></i> <span>ç”Ÿæˆè§†è§’è½ç‚¹ (è‡ªåŠ¨è®¡ç®—)</span>
            </div>
            <div class="prompt-box">
                <textarea id="auto-prompt" readonly placeholder="è°ƒæ•´ä¸Šæ–¹è¿é•œæ†ï¼Œæ­¤å¤„å°†è‡ªåŠ¨ç”Ÿæˆç©ºé—´æç¤ºè¯..."></textarea>
            </div>
            
            <div class="control-item" style="margin-top:10px;">
                <label style="font-size:12px; color:#666;">é¢å¤–é£æ ¼æè¿° (å¯é€‰)</label>
                <input type="text" id="user-prompt" placeholder="ä¾‹å¦‚ï¼šèµ›åšæœ‹å…‹ï¼Œé›¨å¤œï¼Œéœ“è™¹ç¯...">
            </div>
        </div>

        <!-- 4. æ¸²æŸ“æŒ‰é’® -->
        <div class="action-area">
            <select id="model-select" class="model-dropdown">
                <option value="preset">âš¡ ä½¿ç”¨é¢„è®¾æ¨¡å‹ (Fal/Qwen)</option>
                <option value="custom">ğŸ›  ä½¿ç”¨è‡ªå®šä¹‰ API (è®¾ç½®ä¸­é…ç½®)</option>
            </select>
            <button id="generate-btn" class="render-btn">
                <i data-lucide="play"></i> å¼€å§‹æ¸²æŸ“
            </button>
        </div>
    </aside>

    <!-- å³ä¾§ï¼šç»“æœå±•ç¤ºåŒº -->
    <main class="result-stage">
        <div class="stage-toolbar">
            <span class="stage-title">æ¸²æŸ“ç›‘è§†å™¨</span>
            <div class="stage-actions">
                <button onclick="clearStage()" title="æ¸…ç©º"><i data-lucide="trash-2"></i></button>
                <button onclick="downloadCurrent()" title="ä¸‹è½½"><i data-lucide="download"></i></button>
            </div>
        </div>

        <div class="canvas-wrapper">
            <!-- ç©ºçŠ¶æ€ -->
            <div id="empty-state" class="empty-state">
                <div class="empty-icon"><i data-lucide="monitor-off"></i></div>
                <p>ç­‰å¾…æ¸²æŸ“ä¿¡å·è¾“å…¥...</p>
            </div>
            
            <!-- åŠ è½½åŠ¨ç”» -->
            <div id="loader" class="loader" style="display: none;">
                <div class="spinner"></div>
                <p>AI æ­£åœ¨è®¡ç®—å…‰å½±ä¸ç©ºé—´å…³ç³»...</p>
            </div>

            <!-- ç»“æœå›¾ -->
            <img id="result-img" class="final-image" style="display: none;">
        </div>

        <!-- åº•éƒ¨èƒ¶å· -->
        <div class="filmstrip">
            <div class="filmstrip-header">å†å²èƒ¶å·</div>
            <div class="filmstrip-track" id="filmstrip-track"></div>
        </div>
    </main>
</div>

<!-- API è®¾ç½®å¼¹çª— (å¤åˆ»å‚è€ƒé£æ ¼) -->
<div id="config-modal" class="modal-backdrop">
    <div class="modal-panel">
        <div class="modal-header">
            <div class="modal-title">
                <i data-lucide="server"></i>
                <span>æœåŠ¡ä¸æ¨¡å‹é…ç½®</span>
            </div>
            <button class="close-modal"><i data-lucide="x"></i></button>
        </div>
        
        <div class="modal-body">
            <div class="config-section">
                <h3>è‡ªå®šä¹‰ API è¿æ¥</h3>
                <p class="config-desc">é…ç½®å…¼å®¹ OpenAI æ ¼å¼çš„ç¬¬ä¸‰æ–¹æ¥å£ï¼Œæˆ–ç›´æ¥å¡«å…¥ Fal.ai/Google å¯†é’¥ã€‚</p>
                
                <div class="input-group">
                    <label>æ¥å£åœ°å€ (Base URL)</label>
                    <div class="input-wrapper">
                        <i data-lucide="globe"></i>
                        <input type="text" id="cfg-url" placeholder="ä¾‹å¦‚: https://api.openai.com/v1">
                    </div>
                </div>

                <div class="input-group">
                    <label>è®¿é—®å¯†é’¥ (API Key)</label>
                    <div class="input-wrapper">
                        <i data-lucide="key"></i>
                        <input type="password" id="cfg-key" placeholder="sk-...">
                    </div>
                </div>

                <div class="input-group">
                    <label>ç›®æ ‡æ¨¡å‹ (Model ID)</label>
                    <div class="input-wrapper">
                        <i data-lucide="box"></i>
                        <input type="text" id="cfg-model" placeholder="ä¾‹å¦‚: gpt-4-vision-preview">
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button id="save-cfg-btn" class="save-btn">
                <i data-lucide="save"></i> ä¿å­˜å¹¶åº”ç”¨é…ç½®
            </button>
        </div>
    </div>
</div>

<script>
    // åˆå§‹åŒ–å›¾æ ‡
    lucide.createIcons();

    // --- 1. ç´ æä¸Šä¼ ä¸é¢„è§ˆé€»è¾‘ ---
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');
    const sourcePreview = document.getElementById('source-preview');
    const manipulateImg = document.getElementById('manipulate-img');
    const placeholder = document.getElementById('upload-placeholder');
    const noImageHint = document.querySelector('.no-image-hint');

    uploadZone.onclick = () => fileInput.click();

    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                // å·¦ä¸Šè§’é¢„è§ˆ
                sourcePreview.src = e.target.result;
                sourcePreview.classList.remove('hidden');
                placeholder.style.display = 'none';
                
                // è¿é•œå°é¢„è§ˆ
                manipulateImg.src = e.target.result;
                manipulateImg.style.display = 'block';
                noImageHint.style.display = 'none';
            }
            reader.readAsDataURL(file);
        }
    };

    // --- 2. è¿é•œæ§åˆ¶ä¸å®æ—¶äº¤äº’ ---
    const rotateSlider = document.getElementById('rotate-slider');
    const panYSlider = document.getElementById('pan-y-slider');
    const zoomSlider = document.getElementById('zoom-slider');
    
    const valRotate = document.getElementById('val-rotate');
    const valPanY = document.getElementById('val-pan-y');
    const valZoom = document.getElementById('val-zoom');
    
    const autoPromptBox = document.getElementById('auto-prompt');

    function updateCamera() {
        const r = parseInt(rotateSlider.value);
        const y = parseInt(panYSlider.value);
        const z = parseInt(zoomSlider.value);

        // 1. æ›´æ–°æ•°å€¼æ˜¾ç¤º
        valRotate.innerText = `${r}Â°`;
        valPanY.innerText = `${y}%`;
        valZoom.innerText = `${(0.5 + z/100).toFixed(1)}x`;

        // 2. CSS å˜æ¢ (Visual Feedback)
        // æ—‹è½¬ï¼šrotateY å®ç° 3D æ—‹è½¬æ„Ÿ
        // ä¿¯ä»°ï¼štranslateY æ¨¡æ‹Ÿä¸Šä¸‹ç§»åŠ¨
        // ç¼©æ”¾ï¼šscale
        const visualScale = 0.5 + (z / 100); 
        manipulateImg.style.transform = `scale(${visualScale}) rotate(${r}deg) translateY(${y}px)`;

        // 3. è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯ (Prompt Logic)
        generatePromptText(r, y, z);
    }

    function generatePromptText(r, y, z) {
        let parts = [];

        // æ°´å¹³è§†è§’é€»è¾‘
        if (r > 15 && r <= 75) parts.push("Front-Right Side View (å³å‰ä¾§è§†)");
        else if (r > 75 && r <= 105) parts.push("Right Profile View (å³ä¾§æ­£è§†)");
        else if (r > 105) parts.push("Back View (åèƒŒè§†)");
        else if (r < -15 && r >= -75) parts.push("Front-Left Side View (å·¦å‰ä¾§è§†)");
        else if (r < -75 && r >= -105) parts.push("Left Profile View (å·¦ä¾§æ­£è§†)");
        else if (r < -105) parts.push("Back View (åèƒŒè§†)");
        else parts.push("Front View (æ­£è§†)");

        // å‚ç›´è§†è§’é€»è¾‘ (Pan Y)
        if (y > 15) parts.push("Low Angle (ä½æœºä½ä»°è§†)");
        else if (y < -15) parts.push("High Angle (é«˜æœºä½ä¿¯è§†)");
        else parts.push("Eye-level Shot (å¹³è§†)");

        // ç¼©æ”¾é€»è¾‘
        if (z > 70) parts.push("Close-up (ç‰¹å†™)");
        else if (z < 30) parts.push("Wide Shot (å¹¿è§’)");
        else parts.push("Medium Shot (ä¸­æ™¯)");

        autoPromptBox.value = parts.join(", ");
    }

    // ç»‘å®šäº‹ä»¶
    rotateSlider.addEventListener('input', updateCamera);
    panYSlider.addEventListener('input', updateCamera);
    zoomSlider.addEventListener('input', updateCamera);

    // --- 3. æäº¤ç”Ÿæˆ ---
    const generateBtn = document.getElementById('generate-btn');
    const resultImg = document.getElementById('result-img');
    const loader = document.getElementById('loader');
    const emptyState = document.getElementById('empty-state');
    const filmstrip = document.getElementById('filmstrip-track');

    generateBtn.onclick = async () => {
        if (!fileInput.files[0]) {
            alert('âŒ è¯·å…ˆåœ¨â€œæ ¸å¿ƒç´ æâ€åŒºåŸŸä¸Šä¼ å›¾ç‰‡');
            return;
        }

        // UI çŠ¶æ€
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i data-lucide="loader-2" class="spin"></i> æ¸²æŸ“ä¸­...';
        loader.style.display = 'flex';
        resultImg.style.display = 'none';
        emptyState.style.display = 'none';

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        formData.append('prompt', document.getElementById('user-prompt').value);
        
        // ä¼ é€’è¿é•œå‚æ•°
        formData.append('rotate', rotateSlider.value);
        formData.append('pan_y', panYSlider.value);
        formData.append('zoom', zoomSlider.value);
        
        // æ¨¡å‹é…ç½®
        const source = document.getElementById('model-select').value;
        formData.append('model_source', source);
        
        if (source === 'custom') {
            const cfg = JSON.parse(localStorage.getItem('ai_director_cfg') || '{}');
            if(!cfg.url || !cfg.key) {
                alert('è¯·ç‚¹å‡»å³ä¸Šè§’â€œå…¨å±€è®¾ç½®â€é…ç½® API');
                resetBtn();
                return;
            }
            formData.append('custom_api_url', cfg.url);
            formData.append('custom_api_key', cfg.key);
            formData.append('custom_model_name', cfg.model);
        }

        try {
            const res = await fetch('/generate', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.success) {
                const url = data.data.image_url || data.original_image; // Fallback
                resultImg.src = url;
                resultImg.onload = () => {
                    resultImg.style.display = 'block';
                    loader.style.display = 'none';
                    addToHistory(url);
                };
            } else {
                alert('ç”Ÿæˆå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                loader.style.display = 'none';
                emptyState.style.display = 'flex';
            }
        } catch (e) {
            console.error(e);
            alert('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            loader.style.display = 'none';
        } finally {
            resetBtn();
        }
    };

    function resetBtn() {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i data-lucide="play"></i> å¼€å§‹æ¸²æŸ“';
    }

    function addToHistory(url) {
        const div = document.createElement('div');
        div.className = 'film-item';
        div.innerHTML = `<img src="${url}">`;
        div.onclick = () => resultImg.src = url;
        filmstrip.prepend(div);
    }

    // --- 4. é…ç½®å¼¹çª—é€»è¾‘ ---
    const modal = document.getElementById('config-modal');
    document.getElementById('config-btn').onclick = () => {
        const cfg = JSON.parse(localStorage.getItem('ai_director_cfg') || '{}');
        document.getElementById('cfg-url').value = cfg.url || '';
        document.getElementById('cfg-key').value = cfg.key || '';
        document.getElementById('cfg-model').value = cfg.model || '';
        modal.style.display = 'flex';
    };
    
    document.querySelector('.close-modal').onclick = () => modal.style.display = 'none';
    
    document.getElementById('save-cfg-btn').onclick = () => {
        const cfg = {
            url: document.getElementById('cfg-url').value,
            key: document.getElementById('cfg-key').value,
            model: document.getElementById('cfg-model').value
        };
        localStorage.setItem('ai_director_cfg', JSON.stringify(cfg));
        modal.style.display = 'none';
        alert('âœ… é…ç½®å·²ä¿å­˜');
    };

    window.downloadCurrent = () => {
        if(resultImg.src) {
            const a = document.createElement('a');
            a.href = resultImg.src;
            a.download = `AI_Director_${Date.now()}.png`;
            a.click();
        }
    };
    window.clearStage = () => {
        resultImg.style.display = 'none';
        emptyState.style.display = 'flex';
    }
</script>
</body>
</html>
